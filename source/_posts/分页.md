---
title: 分页
top: false
cover: false
toc: true
mathjax: true
date: 2020-10-31 00:10:15
password:
summary:
tags: [OS,分页]
categories: OS
---
## 分页机制的具体细节
<!--more-->
* 页目录：存放页表地址的一个目录（或者说是一个表）
* 页表:存放具体的页帧的地址的一个表
![线性地址和物理地址之间的变换](https://ftp.bmp.ovh/imgs/2020/10/226caa5bbf53d9bd.png)
* 页目录和页表里面的内容都是一样的：共32位，高20位是页帧的物理地址，后12位是一些标志位（比如存在为P），实际上他们无区别，只是解释不同
![页目录页表项](https://ftp.bmp.ovh/imgs/2020/10/00b5e0e8aed71b34.png)
* 实际上一个页目录本身也是一个页面（帧）大小是4K，一个页目录项占4B，因此一个页目录可以放1024个目录项
* 同理，一个页表本身也是一个页面（帧），大小是4K，一个页表项占4B，因此一个页表可以存1024个页帧地址。
* CR3的结构：
![CR3的结构](https://ftp.bmp.ovh/imgs/2020/10/9789493f86f1c729.png)
## 线性地址到物理地址的转换过程
* 首先从CR3寄存器取得页目录基地址，从而找到页目录物理地址
* 取线性地址的高10位为索引号，从页目录中找到对应的页目录项，从而找到页表的物理地址（为什么是十位：因为4K页面内可以存1024个页目录项）
* 取线性地址的接下来10位，作为索引号，从页表中找到对应页表项，里面有页面的物理地址（10位理由同上）
* 然后取线性地址的低12位，作为页内偏移值，精确找到某一Byte。
* 这个寻址过程是硬件完成的（mmu）而不是软件，因为软件不可以接触物理地址
## 64为系统的分页细节
* 64位系统使用48位地址，256TB内存
* 多级分页：
  * 首先一个页面大小还是4K，但是一个页面地址需要64储存，即8B，所以一个页面只能存$2^9$个页面的地址
  * 因此线性地址要分成$9 9 9 9 12$的结构有四级目录
  * 目录分级是为了节省空间，分级之后，没有用到的内存就不需要页表项存在，就不需要内存存它，而如果不分级，总共要分成2^36个页面，共需要2^36 x 8B的内存=512GB的内存存页面地址  