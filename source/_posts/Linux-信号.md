信号是进程间通信的一种方式，它由一个进程或者内核产生，然后传递给另一个进程，作用是告诉目标进程发生了一个特定的事件，有时会强迫目标进程执行它自己代码中的信号处理程序。   
通常一个信号是单独的一个数，以SIG开头的宏表示。  
内核把信号分为两个阶段，一个是信号的产生，在这个阶段内核更新目标进程中的数据结构，比如信号描述符，来表示一个信号已经产生
。  
另一个阶段是信号的传递，如果目标进程没有处于运行状态，信号的传递将会被延迟，直到目标进程从中断或者异常中恢复之前，内核检查进程的相关信号标志，看是否有信号等待处理，有的话就处理它，然后才能恢复进程的正常执行。  
<!--more-->

# 信号
信号在最早的Unix系统中被引入，用于在用户态进程间通信，内核也用信号通知进程系统所发生的事件，信号有30多年的历史，但只有很小的变化。  
## 信号的作用  
信号是很短的消息，可以被发送到一个或者一组进程。发送给进程的唯一信号通常是一个数，以此来标识信号。  
名字前缀为SIG的一组宏用来标识信号。   
比如SIGCHLD宏（扩展值是17），当某一子进程停止或者中止时，SIGCHLD宏产生发送给父进程的信号标识符。  
SIGSEGV宏扩展值是11，当一个进程引用无效的内存时，SIGSEGV宏产生发送给进程的信号标识符。  
信号的两个主要目的是：  
* 让进程知道以及发生了一个特定的事件  
* 强迫进程执行它自己代码中的信号处理程序  

这两个目的不是互斥的，可以同时发生，因为进程经常通过一个特定的例程来对某一事件做出反应。  
Linux处理的0-31号信号叫做常规信号，后来POSIX标准又增加了32个信号，扩展值为32-64，叫做实时信号，他们与常规信号有很大的不同：  
* 实时信号必须排队，以便发送的多个信号能被接收到
* 同种类型的常规信号并不排队，如果一个常规信号被连续发送多次，那么只有其中的一个发送到接收进程。  
 
许多系统调用运行程序员发送信号并决定他们的进程如何响应所接收的信号。  
`kill()`向线程组发送一个信号。  
信号的一个重要特点是它可以随时被发送给状态经常不可预知的进程，发送给非运行进程的信号必须由内核保存，直到进程恢复执行。  
内核区分信号传递的两个同阶段：  
* 信号产生：内核更新目标进程的数据结构以表示一个新信号已经被发送
* 信号传递： 内核强迫目标进程通过以下方式对信号做出反应：或改变目标进程的执行状态，或开始执行一个特定的信号处理程序，或者两个都是。  

每个信号最多被传递一次，它是可消耗资源，一旦它们已经被传递出去，进程描述符中有关这个信号的 所有消息都被取消。  
xxxxxxxxxxxx  
xxxxxxxx  
## 信号的相应结构
信号在进程描述符中有相应的结构：  
```c
/* signal handlers */
    struct signal_struct *signal;
    struct sighand_struct *sighand;

    sigset_t blocked, real_blocked;
    struct sigpending pending;

    unsigned long sas_ss_sp;
    size_t sas_ss_size;
    int (*notifier)(void *priv);
    void *notifier_data;
    sigset_t *notifier_mask;
```
`signal`是一个指针，指向进程的信号描述符。

## 产生信号  
很多内核函数都会产生信号：他们完成信号处理的第一步工作，根据需要更新一个或多个进程的描述符。它们不直接执行第二步信号的传递操作，而是可能根据信号类型和目标进程的状态唤醒一些进程 ，并促使这些进程接收信号。  
当发送给进程一个信号时，这个信号可能来自内核，也可能来自另一个进程。  
  

## 传递信号
我们假定内核已经注意到一个信号的到来，并调用前面所介绍的函数为接收此信号的进程准备信号描述符。但万一这个进程在那一刻并不在cpu上运行，内核就延迟传递信号的任务。而为了确保进程的挂起信号得到处理，内核有一些特殊的操作。  
内核在允许进程恢复用户态下的执行之前，检查进程`TIF_SIGPENDING`标志的值，每当内核处理完一个中断或异常时，就检查是否存在挂起信号。  
为了处理非阻塞的挂起信号，内核调用`do_signal()`这个函数它接收两个参数：
* regs：栈区的地址，当前进程在用户态下寄存器的内容放在这个栈中。
* oldset：变量的地址，假设函数把阻塞信号的位掩码数组存放在这个变量中。如果没有必要保存位掩码数组，则它为NULL。

